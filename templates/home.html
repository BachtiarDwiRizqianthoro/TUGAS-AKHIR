<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Music Recommendation System Real Time</title>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- FontAwesome -->
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
      }

      .header {
        width: 100%;
        height: 100vh;
        background: url('/static/bg.png') center/cover no-repeat;
        background-color: rgba(0, 0, 0, 0.5); /* Warna overlay */
        background-blend-mode: overlay; /* Menggabungkan warna dan gambar */
        color: white;
        position: relative;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }      

      /* Animasi fade-in */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 1.5s ease-in-out;
      }

      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 8%;
        background: rgba(0, 0, 0, 0.7);
        transition: background 0.5s ease;
        width: 100%;
        position: absolute;
        top: 0;
      }

      nav .logo {
        font-size: 30px;
        font-weight: 600;
        color: white;
        display: flex;
        align-items: center;
      }

      nav .logo img {
        width: 40px;
        margin-right: 10px;
      }

      nav ul {
        display: flex;
        list-style: none;
      }

      nav ul li {
        margin: 0 20px;
      }

      nav ul li a {
        text-decoration: none;
        color: white;
        font-weight: 700;
        font-size: 16px;
      }

      nav ul li a:hover,
      nav ul li a.active {
        color: #ffd700;
      }

      .content h1 {
        font-size: 70px;
        font-weight: 700;
        background: -webkit-linear-gradient(left, #ffffff, #ffffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        line-height: 1.2;
      }

      .btn-start {
        border: 2px solid white;
        padding: 15px 40px;
        border-radius: 30px;
        font-weight: 700;
        color: white;
        text-decoration: none;
        transition: background-color 0.3s ease, transform 0.3s ease;
        margin-top: 20px;
      }

      .btn-start:hover {
        background-color: rgb(0, 195, 255);
        transform: scale(1.1);
      }
      .genre-img {
        width: 100%; /* Agar gambar memenuhi lebar kolom */
        height: 150px; /* Tinggi gambar disamakan */
        object-fit: cover; /* Memastikan gambar tidak terdistorsi */
        border-radius: 10px; /* Opsional: Agar sudut gambar sedikit melengkung */
      }
      /* Style baru untuk menempatkan tombol tepat di bawah emoji */
      .expression-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px; /* Jarak antara emoji dan tombol */
        margin-top: 90px; /* Tambahkan margin atas agar lebih ke bawah */
      }
    
      .emoji-container {
        font-size: 70px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .button-container {
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .content h1 {
        font-size: 40px; /* Ubah ukuran teks menjadi lebih kecil */
        font-weight: 900;
        background: -webkit-linear-gradient(left, #ffffff, #ffffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        line-height: 1.2;
      }
      /* Mengatur ukuran gambar emoji */
      .emoji-container img {
        width: 80px; /* Sesuaikan ukuran */
        height: 80px;
        object-fit: contain; /* Agar gambar tidak terpotong */
        background-color: transparent; /* Membuat latar belakang transparan */
      }

      /* Mengatur ukuran gambar genre */
      .genre-img {
        width: 100px; /* Sesuaikan ukuran */
        height: 100px;
        object-fit: contain; /* Menyesuaikan tanpa distorsi */
        background-color: transparent;
      }

      /* Efek hover untuk gambar */
      .emoji-container img:hover,
      .genre-img:hover {
        opacity: 0.7; /* Efek transparan saat hover */
        transform: scale(1.1);
        transition: 0.3s ease-in-out;
      }
      .table td {
        vertical-align: middle; /* Memastikan teks sejajar di tengah */
        text-align: center; /* Memusatkan teks dan tombol */
      }
      
      .form-container {
        background: #fff;
        color: #333;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.2);
        width: 90%; /* Lebarkan form */
        max-width: 800px; /* Batas maksimal lebar */
    }
    .form-control {
        width: 100%;
    }
    .table a.btn {
        display: block;
        width: 80%; /* Agar tombol sejajar */
        text-align: center;
      } 
      .table td, .table th {
        text-align: left !important;
      }
      
    </style>
  </head>
  <body>
    <div class="header">
      <nav class="fade-in">
        <div class="logo">
          <img src="/static/img2.png" alt="Logo" />
          <a href="{{ url_for('home') }}" style="color: white;"><span>Moodify</span></a>
        </div>
        <ul>
          <li><a href="{{ url_for('home') }}" class="{% if request.endpoint == 'home' %}active{% endif %}">Home</a></li>
          <li><a href="{{ url_for('detect') }}" class="{% if request.endpoint == 'detect' %}active{% endif %}">Deteksi</li>
          <li><a href="{{ url_for('history') }}" class="{% if request.endpoint == 'history' %}active{% endif %}">Riwayat</a></li>
          <li><a href="{{ url_for('about') }}" class="{% if request.endpoint == 'about' %}active{% endif %}">Tentang</a></li>
        
          {% if current_user.is_authenticated %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">  Hi, {{ current_user.username }}</a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              <li><a class="dropdown-item" href="{{ url_for('profile') }}">Profile</a></li>
              <li><a class="dropdown-item"href="{{ url_for('logout') }}"id="logout-link">Logout</a>
              </li>
            </ul>
          </li>
          {% else %}
          <li>
            <a href="{{ url_for('login') }}">Login</a>
          </li>
          {% endif %}
        </ul>
      </nav>

      <div class="content fade-in">
        <h1>
          Temukan Musik Yang Cocok Dengan Mood Kamu<br />
          Secara Real-Time!
        </h1>
      </div>

      <!-- Tambahan Emoji -->
      <div class="expression-container fade-in">
        <div class="emoji-container">
          <img src="/static/icon/img1.png" alt="Marah"/>
          <img src="/static/icon/img2.png" alt="Menjijikkan"/>
          <img src="/static/icon/img3.png" alt="Takut"/>
          <img src="/static/icon/img4.png" alt="Senang"/>
          <img src="/static/icon/img5.png" alt="Netral"/>
          <img src="/static/icon/img6.png" alt="Sedih"/>
          <img src="/static/icon/img7.png" alt="Terkejut"/>
        </div>

          <div class="button-container">
            <button class="btn btn-primary" onclick="handleClick('angry')">Marah</button>
            <button class="btn btn-primary" onclick="handleClick('disgusted')">Menjijikkan</button>
            <button class="btn btn-primary" onclick="handleClick('fearful')">Takut</button>
            <button class="btn btn-primary" onclick="handleClick('happy')">Senang</button>
            <button class="btn btn-primary" onclick="handleClick('neutral')">Netral</button>
            <button class="btn btn-primary" onclick="handleClick('sad')">Sedih</button>
            <button class="btn btn-primary" onclick="handleClick('surprised')">Terkejut</button>
          </div>
        </div>


      <!-- Modal untuk Memilih Genre -->
      <div class="modal fade" id="genreModal" tabindex="-1" aria-labelledby="genreModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="genreModalLabel" style="color: black;">Pilih Genre Musik</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <div class="row">
                <div class="col-md-4">
                  <img src="/static/genre/img5.jpg" alt="Pop" class="img-fluid genre-img">
                  <button class="btn btn-secondary m-2" onclick="selectGenre('Pop')">Pop</button>
                </div>
                <div class="col-md-4">
                  <img src="/static/genre/img6.jpeg" alt="Rock" class="img-fluid genre-img">
                  <button class="btn btn-secondary m-2" onclick="selectGenre('Rock')">Rock</button>
                </div>
                <div class="col-md-4">
                  <img src="/static/genre/img2.jpg" alt="Dangdut" class="img-fluid genre-img">
                  <button class="btn btn-secondary m-2" onclick="selectGenre('Dangdut')">Dangdut</button>
                </div>
                <div class="col-md-4">
                  <img src="/static/genre/img3.jpg" alt="Jazz" class="img-fluid genre-img">
                  <button class="btn btn-secondary m-2" onclick="selectGenre('Jazz')">Jazz</button>
                </div>
                <div class="col-md-4">
                  <img src="/static/genre/img1.png" alt="Country" class="img-fluid genre-img">
                  <button class="btn btn-secondary m-2" onclick="selectGenre('country')">Country</button>
                </div>
                <div class="col-md-4">
                  <img src="/static/genre/img4.jpg" alt="Klasik" class="img-fluid genre-img">
                  <button class="btn btn-secondary m-2" onclick="selectGenre('Klasik')">Klasik</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
<!-- Modal Bootstrap untuk daftar lagu -->
<div class="modal fade" id="songsModal" tabindex="-1" aria-labelledby="songsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="songsModalLabel" style="color: black">Rekomendasi Lagu Berdasarkan Umur Anda : {{ current_user.umur }} Tahun</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Tabel untuk menampilkan data lagu -->
        <table class="table table-striped table-hover table-bordered">
          <thead class="table-dark">
            <tr>
              <th>No</th>
              <th>Nama Lagu</th>
              <th>Artis</th>
              <th>Link YouTube</th>
            </tr>
          </thead>
          <tbody id="song-table-body">
            <tr>
              <td colspan="4" class="text-center">Belum ada data</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

      <div class="content fade-in">
        <h2 class="mt-3">
          Pilih Secara Real-Time</h2> <br>
        <a href="index.html" class="btn-start fade-in">Mulai</a>
      </div>
    </div>

    <!-- Modal Bootstrap -->
    <div
      class="modal fade"
      id="songsModal"
      tabindex="-1"
      aria-labelledby="songsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="songsModalLabel">Rekomendasi Lagu</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Tabel untuk menampilkan data lagu -->
            <table class="table table-striped table-hover table-bordered">
              <thead class="table-dark">
                <tr>
                  <th>No</th>
                  <th>Nama Lagu</th>
                  <th>Artis</th>
                  <th>Umur</th>
                  <th>Link YouTube</th>
                </tr>
              </thead>
              <tbody id="song-table-body">
                <tr>
                  <td colspan="4" class="text-center">Belum ada data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="loginAlertModal" tabindex="-1" aria-labelledby="loginAlertModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light"> <div class="modal-header border-secondary"> <h5 class="modal-title" id="loginAlertModalLabel">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
              </svg>
              Perhatian
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button> </div>
          <div class="modal-body">
            Anda harus login terlebih dahulu untuk dapat menonton atau memutar lagu ini. Silakan login untuk melanjutkan.
          </div>
          <div class="modal-footer border-secondary"> <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Tutup</button> <button type="button" class="btn btn-primary" id="loginAlert_redirectToLoginBtn">Login Sekarang</button>
            </div>
        </div>
      </div>
    </div>
    <!-- Script JavaScript -->
    <script>    
      // Fungsi handleClick untuk memanggil endpoint /recommend
      <!-- Di dalam script handleClick pada home.html -->
      function handleClick(emotion) {
        const isLoggedIn = "{{ 'true' if current_user.is_authenticated else 'false' }}";
        const umur = "{{ current_user.umur if current_user.is_authenticated else 'null' }}";
    
        window.selectedEmotion = emotion;
    
        if (isLoggedIn === "true") {
            if (umur !== null && umur <= 13) {
                // Anak-anak → langsung ambil dari folder anak-anak
                fetchSongsForAnakAnak(emotion.toLowerCase());
            } else {
                // Dewasa → pilih genre
                var genreModal = new bootstrap.Modal(document.getElementById("genreModal"));
                genreModal.show();
            }
        } else {
            // Belum login → tetap ambil dari folder umum untuk ditampilkan
            fetchSongsForGuest(emotion.toLowerCase());
        }
    }
    
    function displaySongs(songs) {
        const container = document.getElementById("song-list");
        container.innerHTML = ""; // Clear list
    
        songs.forEach((song) => {
            const item = document.createElement("div");
            item.textContent = `${song.title} - ${song.artist}`;
            container.appendChild(item);
        });
    }

    function fetchSongsForAnakAnak(emotion) {
      const jsonPath = `/static/anak_anak/${emotion}.json`;
  
      fetch(jsonPath)
      .then((response) => response.json())
      .then((data) => {
          if (data.songs && data.songs.length > 0) {
              displaySongs(data.songs);
          } else {
              Swal.fire({
                  icon: "info",
                  title: "Tidak Ada Lagu",
                  text: "Tidak ditemukan lagu untuk ekspresi ini.",
              });
          }
      })
      .catch((error) => {
          console.error("Error:", error);
          Swal.fire({
              icon: "error",
              title: "Gagal",
              text: "Terjadi kesalahan saat mengambil data lagu anak-anak.",
          });
      });
  }
    
    function selectGenre(genre) {
        const emotion = window.selectedEmotion;
    
        // Tutup modal  genre
        var genreModalEl = document.getElementById('genreModal');
        var genreModal = bootstrap.Modal.getInstance(genreModalEl);
        genreModal.hide();
    
        fetchSongsForLoggedInUser(emotion.toLowerCase(), genre.toLowerCase());
    }
    
    // Untuk user yang BELUM login
    function fetchSongsForGuest(emotion) {
        const jsonPath = `/static/songs/${emotion}.json`; // Path ke file json
    
        fetch(jsonPath)
        .then((response) => response.json())
        .then((data) => {
            displaySongs(data.songs);
        })
        .catch((error) => {
            console.error("Error:", error);
            Swal.fire({
                icon: "error",
                title: "Gagal",
                text: "Terjadi kesalahan saat mengambil data lagu.",
            });
        });
    }
    
    // Untuk user yang SUDAH login
    function fetchSongsForLoggedInUser(emotion, genre) {
        fetch("/recommend", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ emotion: emotion, genre: genre }),
        })
        .then((response) => response.json())
        .then((data) => {
            const songsList = data.songs_data?.songs || [];
    
            if (data.status === "success" && songsList.length > 0) {
                displaySongs(songsList);
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Tidak ada lagu yang ditemukan untuk ekspresi dan genre ini.",
                });
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            Swal.fire({
                icon: "error",
                title: "Gagal",
                text: "Tidak ada lagu di genre ini",
            });
        });
    }
    
// Fungsi ini sebaiknya dijalankan sekali setelah DOM siap,
// untuk menempelkan event listener ke songTableBody.
document.addEventListener('DOMContentLoaded', function() {
  const songTableBody = document.getElementById("song-table-body");

  if (songTableBody) {
      songTableBody.addEventListener('click', function(event) {
          // Cek apakah elemen yang diklik adalah tombol "Tonton"
          if (event.target && event.target.classList.contains('watch-song-btn')) {
              // Ambil status login terbaru (diasumsikan dirender oleh template server)
              const isLoggedIn = "{{ 'true' if current_user.is_authenticated else 'false' }}";
              const songLink = event.target.getAttribute('data-song-link');

              if (!songLink || songLink === '#') {
                  console.error('Link lagu tidak valid atau tidak ditemukan pada tombol.');
                  // Anda bisa menampilkan modal lain untuk error ini jika mau
                  alert('Maaf, link lagu ini tidak tersedia.');
                  return;
              }

              if (isLoggedIn === "true") {
                  // Pengguna sudah login, buka link lagu di tab baru
                  console.log("Pengguna sudah login, membuka link:", songLink);
                  window.open(decodeURI(songLink), '_blank');
              } else {
                  // Pengguna belum login, tampilkan modal peringatan login
                  const loginAlertModalElement = document.getElementById('loginAlertModal');
                  if (loginAlertModalElement) {
                      // Dapatkan instance modal Bootstrap atau buat baru jika belum ada
                      let loginAlertModal = bootstrap.Modal.getInstance(loginAlertModalElement);
                      if (!loginAlertModal) {
                          loginAlertModal = new bootstrap.Modal(loginAlertModalElement);
                      }

                      // Atur aksi untuk tombol "Login Sekarang" di dalam modal
                      const redirectToLoginBtn = loginAlertModalElement.querySelector('#loginAlert_redirectToLoginBtn');
                      if (redirectToLoginBtn) {
                          // Penting: perbarui handler onclick setiap kali agar songLink (jika digunakan dalam redirect) selalu yang terbaru
                          redirectToLoginBtn.onclick = function() {
                              // GANTI '/login' DENGAN URL HALAMAN LOGIN ANDA YANG SEBENARNYA
                              // Pertimbangkan untuk menambahkan link lagu sebagai parameter 'next'
                              // Contoh: window.location.href = '/login?next=' + encodeURIComponent(decodeURI(songLink));
                              window.location.href = '/login'; 
                          };
                      }
                      loginAlertModal.show(); // Tampilkan modal
                  } else {
                      // Fallback ke alert standar jika elemen modal tidak ditemukan
                      console.error("Elemen modal 'loginAlertModal' tidak ditemukan. Menggunakan alert standar.");
                      alert("Anda harus login terlebih dahulu untuk menonton/memutar lagu ini.");
                      window.location.href = '/login';
                  }
              }
          }
      });
  } else {
      console.error("Elemen dengan ID 'song-table-body' tidak ditemukan saat DOMContentLoaded.");
  }
});

// Fungsi displaySongs Anda (tidak berubah dari versi sebelumnya yang menggunakan tombol dengan data-song-link)
function displaySongs(songsList) {
  let songTableBody = document.getElementById("song-table-body");
  if (!songTableBody) {
      console.error("Elemen dengan ID 'song-table-body' tidak ditemukan dalam displaySongs.");
      return;
  }
  
  let rowsHTML = ""; 
  songsList.forEach((song, index) => {
      const safeSongLink = song.Link ? encodeURI(song.Link) : '#';
      const safeSongName = song.Name ? song.Name.replace(/"/g, '&quot;') : 'Lagu Tidak Dikenal';
      const safeArtistName = song.Artist ? song.Artist.replace(/"/g, '&quot;') : 'Artis Tidak Dikenal';

      rowsHTML += `
          <tr>
              <td>${index + 1}</td>
              <td>${safeSongName}</td>
              <td>${safeArtistName}</td>
              <td>
                  <button type="button" 
                          class="btn btn-primary btn-sm d-block mx-auto watch-song-btn" 
                          data-song-link="${safeSongLink}"
                          aria-label="Tonton ${safeSongName} oleh ${safeArtistName}">
                      Tonton
                  </button>
              </td>
          </tr>`;
  });
  songTableBody.innerHTML = rowsHTML;

  var songsModalElement = document.getElementById("songsModal"); // Ini modal untuk daftar lagu Anda
  if (songsModalElement) {
      var songsModal = bootstrap.Modal.getInstance(songsModalElement) || new bootstrap.Modal(songsModalElement);
      songsModal.show();
  } else {
      console.error("Elemen modal dengan ID 'songsModal' tidak ditemukan.");
  }
}


//ini history
function displaySongs(songsList, emotion, genre, age) {
  const songTableBody = document.getElementById("song-table-body");
  if (!songTableBody) {
      console.error("Elemen 'song-table-body' tidak ditemukan.");
      return;
  }

  if (!songsList || songsList.length === 0) {
      songTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada lagu yang ditemukan.</td></tr>';
  } else {
      let rowsHTML = "";
      songsList.forEach((song, index) => {
          const safeSongLink = song.Link ? encodeURI(song.Link) : '#';
          const safeSongName = song.Name ? song.Name.replace(/"/g, '&quot;') : 'Lagu Tidak Dikenal';
          const safeArtistName = song.Artist ? song.Artist.replace(/"/g, '&quot;') : 'Artis Tidak Dikenal';
          const genreForHistory = genre || 'Anak-Anak';

          rowsHTML += `
              <tr>
                  <td>${index + 1}</td>
                  <td>${safeSongName}</td>
                  <td>${safeArtistName}</td>
                  <td class="text-center">
                      <button type="button" 
                              class="btn btn-primary btn-sm watch-song-btn" 
                              data-song-link="${safeSongLink}"
                              data-song-name="${safeSongName}"
                              data-song-artist="${safeArtistName}"
                              data-emotion="${emotion}"   
                              data-genre="${genreForHistory}"
                              data-age="${age}">
                          Tonton
                      </button>
                  </td>
              </tr>`;
      });
      songTableBody.innerHTML = rowsHTML;
  }

  const songsModal = new bootstrap.Modal(document.getElementById("songsModal"));
  songsModal.show();
}

/**
* PERUBAHAN 3: Perbarui fungsi yang memanggil displaySongs
*/
function fetchSongsForLoggedInUser(emotion, genre) {
  // Kategori umur untuk user login diasumsikan "Dewasa"
  const ageCategory = "Dewasa"; 
  fetch("/recommend", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ emotion: emotion, genre: genre }),
  })
  .then((response) => response.json())
  .then((data) => {
      const songsList = data.songs_data?.songs || [];
      if (data.status === "success" && songsList.length > 0) {
          // Kirim 'ageCategory' ke displaySongs
          displaySongs(songsList, emotion, genre, ageCategory);
      } else {
          // ... (sisa kode sama)
      }
  })
  .catch((error) => {
      // ... (sisa kode sama)
  });
}

function fetchSongsForAnakAnak(emotion) {
  // Kategori umur untuk anak-anak adalah "Anak-Anak"
  const ageCategory = "Anak-Anak"; 
  const jsonPath = `/static/anak_anak/${emotion}.json`;
  fetch(jsonPath)
      .then(response => response.json())
      .then(data => {
          const songsList = data.songs || [];
          if (songsList.length > 0) {
              // Kirim 'ageCategory' ke displaySongs. Genre diisi null.
              displaySongs(songsList, emotion, null, ageCategory); 
          } else {
              // ... (sisa kode sama)
          }
      })
      .catch(error => console.error('Error fetching kids songs:', error));
}


/**
* PERUBAHAN 4: Tambahkan event listener yang mengirim data ke /log_history
* Pastikan Anda punya event listener seperti ini. Jika belum, tambahkan.
*/
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('watch-song-btn')) {
      const button = event.target;

      // Ambil semua data dari tombol, termasuk 'age'
      const songData = {
          name: button.dataset.songName,
          artist: button.dataset.songArtist,
          link: button.dataset.songLink,
          emotion: button.dataset.emotion,
          genre: button.dataset.genre,
          age: button.dataset.age // Ambil data umur
      };
      
      // Cek jika pengguna login sebelum menyimpan riwayat
      // Asumsi: Jika tombol logout ada, berarti user login.
      if (document.getElementById('logout-link')) {
           // Buka link YouTube di tab baru
          window.open(songData.link, '_blank');
          // Kirim data ke backend untuk disimpan
          logHistoryToServer(songData);
      } else {
          // Jika tidak login, langsung buka link tanpa menyimpan
          window.open(songData.link, '_blank');
      }
  }
});

function logHistoryToServer(songData) {
  fetch('/log_history', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
      },
      body: JSON.stringify(songData)
  })
  .then(response => response.json())
  .then(data => {
      if (data.status === 'success') {
          console.log('History saved successfully:', data.message);
      } else {
          console.error('Failed to save history:', data.message);
      }
  })
  .catch((error) => {
      console.error('Error while saving history:', error);
  });
}
    
// Fungsi handleClick Anda juga tetap sama
/*
function handleClick(emotion) {
  // ... (logika handleClick seperti sebelumnya)
}
*/

           

        document.getElementById("filter-form").addEventListener("submit", function(event) {
          event.preventDefault();
          let emotion_id = document.getElementById("emotion").value;

          fetch("/filter", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ "emotion_id": emotion_id })
          })
          .then(response => response.json())
          .then(data => {
              console.log("Response JSON:", data);  // Debugging output
          
              let songTableBody = document.getElementById("song-table-body");
              songTableBody.innerHTML = "";  // Kosongkan tabel sebelum menambahkan lagu baru
          
              if (data.songs && data.songs.length > 0) {
                  data.songs.forEach((song, index) => {
                      let row = `<tr>
                          <td>${index + 1}</td>
                          <td>${song.Name}</td>
                          <td>${song.Artist}</td>
                          <td>
                              <a href="${song.Link}" target="_blank" class="btn btn-primary btn-sm d-block mx-auto">
                                Tonton
                              </a>
                          </td>
                      </tr>`;
                      songTableBody.innerHTML += row;
                  });
          
                  // Tampilkan teks "Ini adalah lagu yang ditelusuri"
                  document.getElementById("searched-text").style.display = "block";
          
              } else {
                  songTableBody.innerHTML = "<tr><td colspan='4' class='text-center'>No recommendations available for this emotion.</td></tr>";
          
                  // Sembunyikan teks jika tidak ada hasil
                  document.getElementById("searched-text").style.display = "none";
              }
          })
        });
      

          // Ambil pesan flash dari Flask
    const flashSuccess = "{{ get_flashed_messages(category_filter=['success'])[0] if get_flashed_messages(category_filter=['success']) else '' }}";

    // Jika login sukses, tampilkan SweetAlert2
    if (flashSuccess) {
        Swal.fire({
            icon: "success",
            title: "Login Berhasil!",
            text: flashSuccess,
            confirmButtonColor: "#28a745"
        });
    }
    document
    .getElementById("logout-link")
    .addEventListener("click", function (event) {
      event.preventDefault();
      Swal.fire({
        title: "Apakah anda yakin ingin logout?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Ya, logout!",
        cancelButtonText: "Tidak, stay!",
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = this.href;
        }
      });
    });

    </script>
  </body>
</html>
